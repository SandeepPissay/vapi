var toc = require('marked-toc');
var fs = require('fs');

module.exports = {
  book: {
  },
  blocks: {
    // To add TOC to your page, add "{% tocTag %} {% endtocTag %}"
    tocTag: {
      process: function(nothing) {
        var fileContent = fs.readFileSync(this.ctx.file.path, 'utf8');
        var tocData = (toc.raw(fileContent)).data;

        var htmlToc = "<ul>\n";

        var prevDepth = 1
        for(var i=0 ; i< tocData.length; i++) {
          var url = tocData[i].url;
          var heading = tocData[i].heading;
          var depth = tocData[i].depth.length/2 +1;

          // Headings deeper than the third level will not be listed in the TOC.
          if(depth > 3) {
            continue;
          }

          if(prevDepth < depth) {
            htmlToc += new Array( depth - prevDepth + 1 ).join( "<ul>" );
          }
          if(prevDepth > depth) {
            htmlToc += new Array( prevDepth - depth + 1 ).join( "</ul>" );
          }
          htmlToc += "<li><a href=\"#" + url + "\">" + heading + "</a></li>\n";
          prevDepth = depth;
        }

        htmlToc += "</ul>";
        return htmlToc;
      }
    }
  }
};
